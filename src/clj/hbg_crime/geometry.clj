(ns hbg-crime.geometry)

;;; Definitions appended to bottom
(declare neighborhoods)

(defn- crossing-number
  "Determine crossing number for given point and segment of a polygon.
   See http://geomalgorithms.com/a03-_inclusion.html"
  [[px py] [[x1 y1] [x2 y2]]]
  (if (or (and (<= y1 py) (> y2 py))
          (and (> y1 py) (<= y2 py)))
    (let [vt (/ (- py y1) (- y2 y1))]
      (if (< px (+ x1 (* vt (- x2 x1))))
        1 0))
    0))

(defn inside?
  "Is point inside the given polygon?"
  [point polygon]
  (odd? (reduce + (for [n (range (- (count polygon) 1))]
                    (crossing-number point [(nth polygon n)
                                            (nth polygon (+ n 1))])))))

(defn neighborhood-for-point
  "Which neighborhood does this point belong to?"
  [point]
  (if-not (some nil? point)
    (first (first (filter #(inside? point (last %)) neighborhoods)))))

;;; Neighborhood polygon definitions

(def downtown
  [
   [-76.890350,40.264832]
   [-76.881767,40.268372]
   [-76.880051,40.265942]
   [-76.878937,40.266270]
   [-76.876442,40.260658]
   [-76.873230,40.255589]
   [-76.876907,40.255440]
   [-76.873558,40.253410]
   [-76.873291,40.252411]
   [-76.873611,40.251240]
   [-76.877678,40.254768]
   [-76.878761,40.255390]
   [-76.882919,40.258110]
   [-76.885933,40.254940]
   [-76.883400,40.252838]
   [-76.883308,40.251759]
   [-76.887863,40.253300]
   [-76.888931,40.253521]
   [-76.890091,40.254108]
   [-76.891678,40.255428]
   [-76.893661,40.258308]
   [-76.893661,40.259029]
   [-76.891548,40.258900]
   [-76.889313,40.257580]
   [-76.887520,40.256050]
   [-76.884773,40.259029]
   [-76.890411,40.263397]
   [-76.890625,40.264004]
   [-76.890350,40.264832]
   ])

(def midtown
  [
   [-76.899666,40.277897]
   [-76.887398,40.281204]
   [-76.886620,40.278454]
   [-76.884781,40.274296]
   [-76.881874,40.268475]
   [-76.890327,40.265053]
   [-76.891388,40.265388]
   [-76.892929,40.267422]
   [-76.894264,40.269485]
   [-76.895111,40.270782]
   [-76.899750,40.277561]
   [-76.899666,40.277897]
   ])

(def uptown
  [
   [-76.899979,40.277908]
   [-76.905258,40.288906]
   [-76.906013,40.290821]
   [-76.906357,40.293571]
   [-76.905853,40.295715]
   [-76.902512,40.303967]
   [-76.900864,40.308659]
   [-76.898247,40.310394]
   [-76.896751,40.310566]
   [-76.893913,40.309837]
   [-76.893478,40.301262]
   [-76.890831,40.292564]
   [-76.887260,40.281490]
   [-76.899979,40.277908]
   ])

(def northern-tier
  [
   [-76.883957,40.282509]
   [-76.885590,40.283951]
   [-76.889877,40.297501]
   [-76.892326,40.325806]
   [-76.891678,40.325901]
   [-76.887947,40.323612]
   [-76.884254,40.320702]
   [-76.883484,40.319489]
   [-76.882584,40.315922]
   [-76.881340,40.310326]
   [-76.881248,40.307217]
   [-76.881340,40.294353]
   [-76.881897,40.291901]
   [-76.882538,40.289608]
   [-76.881126,40.283321]
   [-76.883957,40.282509]
   ])

(def allison-hill
  [
   [-76.883820,40.282108]
   [-76.881378,40.282810]
   [-76.880089,40.282829]
   [-76.878990,40.282269]
   [-76.878258,40.281670]
   [-76.877449,40.281139]
   [-76.876633,40.280800]
   [-76.875732,40.280781]
   [-76.874924,40.280811]
   [-76.874229,40.280651]
   [-76.873367,40.280239]
   [-76.871964,40.279079]
   [-76.870934,40.278568]
   [-76.869919,40.278389]
   [-76.867661,40.278511]
   [-76.866699,40.278339]
   [-76.863739,40.277069]
   [-76.860825,40.277954]
   [-76.858589,40.274090]
   [-76.852715,40.275169]
   [-76.851036,40.274940]
   [-76.845634,40.273209]
   [-76.844002,40.273598]
   [-76.842667,40.273273]
   [-76.841812,40.272617]
   [-76.840523,40.272488]
   [-76.838463,40.272289]
   [-76.837692,40.271832]
   [-76.837090,40.269703]
   [-76.836510,40.268604]
   [-76.836166,40.268082]
   [-76.836128,40.267445]
   [-76.841408,40.267754]
   [-76.839668,40.258633]
   [-76.851616,40.257881]
   [-76.851746,40.254604]
   [-76.852173,40.254410]
   [-76.850586,40.250740]
   [-76.852371,40.245453]
   [-76.856018,40.244568]
   [-76.858505,40.239536]
   [-76.867691,40.245598]
   [-76.870262,40.247662]
   [-76.872757,40.250118]
   [-76.868637,40.252346]
   [-76.871895,40.255787]
   [-76.872231,40.258961]
   [-76.876701,40.268162]
   [-76.881119,40.277691]
   [-76.883820,40.282108]
   ])

(def neighborhoods
  {:downtown downtown
   :midtown midtown
   :uptown uptown
   :norther-tier northern-tier
   :allison-hill allison-hill})
